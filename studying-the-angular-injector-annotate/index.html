<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Tao of Code: Studying the Angular JS Injector - annotate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/androidstudio.css">
    <link href="../css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/index.html">Tao of Code</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/index.html">Home</a></li>
                
                <li><a href="/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div id="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">February 19, 2014</div>
        
    </div>
    <h2>Studying the Angular JS Injector - annotate</h2>
</div>
<div>
    
    <p>(This post is part of a series <a href='http://taoofcode.net/studying-the-angular-injector/'>studying the AngularJS injector</a>)</p><p>In order for the Injector to know what to inject into a given functions parameters, it needs a list of these parameters. This is what the <code>annotate</code> function does.</p><p>There are three different ways in Angular to annotate your methods.</p><ul><li>Use an array. The last element of the array is the function, the rest is a list of the parameter names.<pre><code class="language-javascript">&#91;'$scope', '$q', function&#40;$scope, $q&#41; {}
</code></pre></li><li>Add a <code>$inject</code> property to the function containing a list of the parameters.<pre><code class="language-javascript">function myFunction&#40;$scope, $q&#41; {}
myFunction.$inject = &#91;'$scope', '$q'&#93;;
</code></pre></li><li>Nothing at all. Angular can parse the parameters straight out of the function. This does not work when your code is minified since the minification renames your parameters to the smallest length possible.<pre><code class="language-javascript">function myFunction&#40;$scope, $q&#41; {}
</code></pre></li></ul><p>Lets look at the code.</p><pre><code class="language-javascript">var FN&#95;ARGS = /&#94;function\s&#42;&#91;&#94;\&#40;&#93;&#42;\&#40;\s&#42;&#40;&#91;&#94;\&#41;&#93;&#42;&#41;\&#41;/m;
var FN&#95;ARG&#95;SPLIT = /,/;
var FN&#95;ARG = /&#94;\s&#42;&#40;&#95;?&#41;&#40;\S+?&#41;\1\s&#42;$/;
var STRIP&#95;COMMENTS = /&#40;&#40;\/\/.&#42;$&#41;|&#40;\/\&#42;&#91;\s\S&#93;&#42;?\&#42;\/&#41;&#41;/mg;
var $injectorMinErr = minErr&#40;'$injector'&#41;;
function annotate&#40;fn&#41; {
  var $inject,
      fnText,
      argDecl,
      last;

  if &#40;typeof fn == 'function'&#41; {
    if &#40;!&#40;$inject = fn.$inject&#41;&#41; {
      $inject = &#91;&#93;;
      if &#40;fn.length&#41; {
        fnText = fn.toString&#40;&#41;.replace&#40;STRIP&#95;COMMENTS, ''&#41;;
        argDecl = fnText.match&#40;FN&#95;ARGS&#41;;
        forEach&#40;argDecl&#91;1&#93;.split&#40;FN&#95;ARG&#95;SPLIT&#41;, function&#40;arg&#41;{
          arg.replace&#40;FN&#95;ARG, function&#40;all, underscore, name&#41;{
            $inject.push&#40;name&#41;;
          }&#41;;
        }&#41;;
      }
      fn.$inject = $inject;
    }
  } else if &#40;isArray&#40;fn&#41;&#41; {
    last = fn.length - 1;
    assertArgFn&#40;fn&#91;last&#93;, 'fn'&#41;;
    $inject = fn.slice&#40;0, last&#41;;
  } else {
    assertArgFn&#40;fn, 'fn', true&#41;;
  }
  return $inject;
}
</code></pre><p><code>annotate</code> is passed either an array or a function.</p><p>If an array has been passed into <code>annotate</code>, it is assumed to be in the first form (<code>&#91;'$scope', function&#40;$scope&#41; {..</code>). In this case, we assert that the last element in the array is a function and then remove that element returning the array.</p><p>If it is just a function passed in, first it checks if the function has already been annotated by setting a <code>$inject</code> property.<pre><code class="language-javascript">    if &#40;!&#40;$inject = fn.$inject&#41;&#41; {
 </code></pre></p><p>If it hasn't been, we need to extract the parameters from the function definition itself. This part of the code gives us an enjoyable journey through the power of regular expressions.<pre><code class="language-javascript">      $inject = &#91;&#93;;
      if &#40;fn.length&#41; {
        fnText = fn.toString&#40;&#41;.replace&#40;STRIP&#95;COMMENTS, ''&#41;;
        argDecl = fnText.match&#40;FN&#95;ARGS&#41;;
        forEach&#40;argDecl&#91;1&#93;.split&#40;FN&#95;ARG&#95;SPLIT&#41;, function&#40;arg&#41;{
          arg.replace&#40;FN&#95;ARG, function&#40;all, underscore, name&#41;{
            $inject.push&#40;name&#41;;
          }&#41;;
        }&#41;;
      }
 </code></pre></p><p>Angular takes advantage of the fact that calling <code>toString&#40;&#41;</code> on a function definition returns the full text of the function. We can see this in the nodejs repl:<pre><code class="language-javascript">&gt; var x = function&#40;a,b,c&#41; { };
undefined
&gt; x.toString&#40;&#41;;
'function&#40;a,b,c&#41; { }'
 </code></pre></p><p><code>toString&#40;&#41;</code> returns the function exactly as it has been entered in the script, including comments.</p><p>These comments get in the way of parsing the parameters, so first the method strips any comments from the function. Anything that matches the regex <code>/&#40;&#40;\/\/.&#42;$&#41;|&#40;\/&amp;#42;&#91;\s\S&#93;&#42;?&amp;#42;\/&#41;&#41;/mg</code> is removed. The first part of that regex (<code>&#40;\/\/.&#42;$&#41;</code>) matches anything starting with // up to the end of the line. The second part (<code>&#40;\/&amp;#42;&#91;\s\S&#93;&#42;?&amp;#42;\/&#41;</code>) matches anything between a /<em> and </em>/. </p><p>Let's see if this works :</p><pre><code class="language-javascript">&gt;var fn = function&#40;c/&#42;a parameter&#42;/, a, // More parameters
...                 /&#42; Interesting &#42;/ r&#41; { };
&gt; fn.toString&#40;&#41;.replace&#40;/&#40;&#40;\/\/.&#42;$&#41;|&#40;\/\&#42;&#91;\s\S&#93;&#42;?\&#42;\/&#41;&#41;/mg, ''&#41;;
'function &#40;c, a,
                  r&#41; { }'
</code></pre><p>It works, the comments are stripped out.</p><p>Next it pulls out the argument list with the regex match : <code>/&#94;function\s&#42;&#91;&#94;&amp;#40;&#93;&#42;&amp;#40;\s&#42;&#40;&#91;&#94;&amp;#41;&#93;&#42;&#41;&amp;#41;/m</code></p><p>This regex is bordering on the complex. Let's break it down.</p><ul><li><strong><sup></strong></sup> : From the start of the string</li><li><strong>function</strong> : match the text <em>function</em></li><li>**\s*** : any amount of whitespace</li><li>**[<sup>&#92;(]***</sup> : any character that is not a '('. This will be whitespace and the function name.</li><li><strong>&#92;(</strong> : the '(' character. Note ( is a special char in regular expressions, so the '\' is needed to escape it and make the regex treat it as a real character.</li><li>**\s*** : more whitespace</li><li><strong>([<sup>&#41;]*)</strong></sup> : Any character that is not a ')'. Also note that this part of the pattern is within '(' and ')'. This is a group and means we are especially interested in what is matched here.</li><li><strong>&#41;</strong> : The closing ')'. </li></ul><p>Does it work?</p><pre><code class="language-javascript">&gt;fnText.match&#40;/&#94;function\s&#42;&#91;&#94;\&#40;&#93;&#42;\&#40;\s&#42;&#40;&#91;&#94;\&#41;&#93;&#42;&#41;\&#41;/m&#41;
&#91; 'function &#40;c, a, \r\n                  r&#41;',
  'c, a, \r\n                  r',
  index: 0,
  input: 'function &#40;c, a, \r\n                  r&#41; { }' &#93;
</code></pre><p><code>match</code> returns an array of the matches found by the regex. The first element in the array is the whole text matched. Each ensuing element is each group found within the regex. The group matched here is anything between the brackets after the text 'function'. In this case it is the text <code>'c, a, \r\n                  r',</code> which is our parameter list (plus the newlines and white space).</p><p>The code then splits this string at the commas. For each of these then does a further call to replace.<pre><code class="language-javascript">arg.replace&#40;FN&#95;ARG, function&#40;all, underscore, name&#41;{
            $inject.push&#40;name&#41;;
          }&#41;;
 </code></pre></p><p>Now looking at the documentation for <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global&#95;Objects/String/replace'>replace</a> you are supposed to call this function with the search string and a function which is supposed to return the string that you replace it with. This code doesn't do this. Instead it just takes the matched string and pushes it into the <code>$inject</code> array, ignoring any return value. An interesting and neat way to find matches within text.</p><p>Lets look at the regex used to match these parameters <code>/&#94;\s&#42;&#40;&#95;?&#41;&#40;\S+?&#41;\1\s&#42;$/</code> :</p><ul><li><strong><sup></strong></sup> : the beginning of the parameter text</li><li>**&#92;s*** : any amount of whitespace</li><li><strong>(<b>?)</strong> : 0 or more '</b>' characters.</li><li><strong>(\S+?)</strong> : 1 or more non-whitespace characters. The ? makes it a lazy match, it will match as few characters as possible - so this will stop matching when we get to the underscores defined in the next section.</li><li><strong>\1</strong> : This matchs the substring that is the same as that in group 1. This is the underscores. The effect of this is to ensure that if our parameter starts with a certain number of _ characters that it will end with the same amount.</li><li>**\s*** : any amount of whitespace</li></ul><p>An interesting point to take away from this pattern is that in your Angular module you can surround your parameters with any number of underscores and (as long as there is the same amount on either side) these will not be included in the annotation and consequent service location.</p><p>Phew, that's a lot of regex.</p><p>We should now have a list of the parameters which the injector can then use to locate the values to inject into our function.</p><p>Next: <a href='http://taoofcode.net/studying-the-angular-injector-invoke'>invoke</a></p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/angularjs.html">angularjs</a>
    
    <a href="/tags/javascript.html">javascript</a>
    
</div>


    <div id="prev-next">
        
        <a href="/studying-the-angular-injector/">&laquo; Studying the Angular JS Injector - intro</a>
        
        
        <a class="right" href="/promise-anti-patterns/">Promise Anti-patterns &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//taoofcode.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/angularjs.html">angularjs</a></li>
                        
                        <li><a href="/tags/javascript.html">javascript</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="../js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

